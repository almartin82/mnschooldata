---
title: "Minnesota Enrollment Trends"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Minnesota Enrollment Trends}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, eval = TRUE, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.width = 10,
  fig.height = 6,
  out.width = "100%",
  message = FALSE,
  warning = FALSE
)
```

```{r load-packages, eval = TRUE}
library(mnschooldata)
library(ggplot2)
library(dplyr)
library(scales)
```

```{r theme, eval = TRUE}
theme_readme <- function() {
  theme_minimal(base_size = 14) +
    theme(
      plot.title = element_text(face = "bold", size = 16),
      plot.subtitle = element_text(color = "gray40"),
      panel.grid.minor = element_blank(),
      legend.position = "bottom"
    )
}

colors <- c("total" = "#2C3E50", "white" = "#3498DB", "black" = "#E74C3C",
            "hispanic" = "#F39C12", "asian" = "#9B59B6", "native" = "#1ABC9C")
```

```{r fetch-data, eval = FALSE}
# Fetch multi-year data for trends
# NOTE: This code is for illustration only. In practice, use cached data.
enr <- fetch_enr_multi(2015:2024, use_cache = TRUE)
enr_current <- fetch_enr(2024, use_cache = TRUE)
```

```{r load-cached-data, eval = TRUE}
# Load cached data for vignette building
# This prevents network calls during CRAN checks and pkgdown builds
data("enr_multi_example", package = "mnschooldata")
data("enr_2024_example", package = "mnschooldata")

enr <- enr_multi_example
enr_current <- enr_2024_example
```

## 1. Minneapolis and St. Paul are shrinking

The Twin Cities' two largest urban districts have each lost over 10,000 students in the past decade, driven by declining birth rates, rising housing costs, and competition from charters and suburbs.

```{r twin-cities-decline, eval = FALSE}
tc <- enr %>%
  filter(is_district, grepl("Minneapolis|St. Paul", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(tc, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "Minneapolis and St. Paul Are Shrinking",
       subtitle = "Each lost over 10,000 students in the past decade",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 2. Somali students transformed Minneapolis schools

Minneapolis has one of the largest Somali populations in the United States, fundamentally changing the city's schools over two decades. Black students now make up approximately 35% of Minneapolis enrollment.

```{r mpls-demographics, eval = FALSE}
mpls <- enr %>%
  filter(is_district, grepl("Minneapolis", district_name, ignore.case = TRUE),
         !grepl("Special", district_name),
         grade_level == "TOTAL",
         subgroup %in% c("white", "black", "hispanic", "asian"))

ggplot(mpls, aes(x = end_year, y = pct * 100, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = colors,
                     labels = c("Asian", "Black", "Hispanic", "White")) +
  labs(title = "Minneapolis Demographics Transformation",
       subtitle = "Black students (including large Somali population) approach 35%",
       x = "School Year", y = "Percent", color = "") +
  theme_readme()
```

## 3. Charter schools serve 60,000+ students

Minnesota invented charter schools in 1991 - the first state to do so. Today, over 180 charter schools serve nearly 7% of the state's students. Charter enrollment has grown steadily while traditional district enrollment has declined.

```{r charter-enrollment, eval = FALSE}
# Charter schools in Minnesota have district IDs starting with "07"
charter <- enr %>%
  filter(is_district, grepl("^07", district_id),
         subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  group_by(end_year) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE),
            n_charters = n_distinct(district_id),
            .groups = "drop")

ggplot(charter, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma) +
  labs(title = "Minnesota Invented Charter Schools",
       subtitle = "Over 60,000 students in 180+ charters - nation's first charter law (1991)",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 4. Suburban ring is booming

While Minneapolis and St. Paul shrink, the suburban ring continues to grow. Districts like Anoka-Hennepin (the state's largest), Lakeville, and Rosemount-Apple Valley-Eagan have absorbed families leaving the urban core.

```{r suburban-growth, eval = FALSE}
suburban <- enr %>%
  filter(is_district,
         grepl("Anoka-Hennepin|Lakeville|Rosemount|Prior Lake", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(suburban, aes(x = end_year, y = n_students, color = district_name)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "Suburban Ring is Booming",
       subtitle = "Metro suburbs growing while core cities shrink",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 5. Minnesota is diversifying fast

From 85% white in 2007 to under 70% today, Minnesota is experiencing one of the fastest demographic shifts in the Midwest. Hispanic and Asian populations are growing rapidly, while the white student share declines.

```{r demographics-shift, eval = FALSE}
demo <- enr %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "black", "hispanic", "asian"))

ggplot(demo, aes(x = end_year, y = pct * 100, color = subgroup)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  scale_color_manual(values = colors,
                     labels = c("Asian", "Black", "Hispanic", "White")) +
  labs(title = "Minnesota Diversifying Fast",
       subtitle = "From 85% white in 2007 to under 70% today",
       x = "School Year", y = "Percent", color = "") +
  theme_readme()
```

## 6. COVID hit kindergarten hard

The pandemic caused an 8% drop in Minnesota kindergarten enrollment in 2021 - nearly 5,000 fewer children. This "COVID cohort" is smaller than surrounding grades as it moves through the system.

```{r covid-kindergarten, eval = FALSE}
k_trend <- enr %>%
  filter(is_state, subgroup == "total_enrollment",
         grade_level %in% c("K", "01", "06", "12")) %>%
  mutate(grade_label = case_when(
    grade_level == "K" ~ "Kindergarten",
    grade_level == "01" ~ "Grade 1",
    grade_level == "06" ~ "Grade 6",
    grade_level == "12" ~ "Grade 12"
  ))

ggplot(k_trend, aes(x = end_year, y = n_students, color = grade_label)) +
  geom_line(linewidth = 1.2) +
  geom_point(size = 2.5) +
  geom_vline(xintercept = 2021, linetype = "dashed", color = "red", alpha = 0.5) +
  scale_y_continuous(labels = comma) +
  labs(title = "COVID Hit Minnesota Kindergarten Hard",
       subtitle = "Lost 8% - nearly 5,000 fewer kids in 2021",
       x = "School Year", y = "Students", color = "") +
  theme_readme()
```

## 7. Iron Range still declining

Minnesota's Iron Range - the mining region in the northeast - continues its decades-long population decline. Districts like Hibbing, Virginia, and Eveleth-Gilbert have lost students as mining employment decreases and young families move away.

```{r iron-range-decline, eval = FALSE}
iron_range <- enr %>%
  filter(is_district,
         grepl("Hibbing|Virginia|Eveleth|Chisholm|Mountain Iron", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  group_by(end_year) %>%
  summarize(n_students = sum(n_students, na.rm = TRUE), .groups = "drop")

ggplot(iron_range, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma) +
  labs(title = "Iron Range Still Declining",
       subtitle = "Combined enrollment for Hibbing, Virginia, Eveleth, Chisholm, Mountain Iron",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 8. Rochester: A growing city

Driven by the Mayo Clinic and its $5 billion expansion (Destination Medical Center), Rochester is one of the few outstate cities gaining students. The district has added over 2,000 students in the past decade.

```{r rochester-growth, eval = FALSE}
rochester <- enr %>%
  filter(is_district, grepl("Rochester", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(rochester, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Rochester: A Growing City",
       subtitle = "Mayo Clinic expansion driving school enrollment growth",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 9. English learners approaching 10%

Over 80,000 Minnesota students are English learners, concentrated heavily in the Twin Cities metro. Minneapolis, St. Paul, and suburban districts like Brooklyn Center and Richfield have EL populations exceeding 30%.

```{r el-concentration, eval = FALSE}
el <- enr_current %>%
  filter(is_district, subgroup == "lep", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  head(10) %>%
  mutate(district_label = reorder(district_name, n_students))

ggplot(el, aes(x = district_label, y = n_students)) +
  geom_col(fill = colors["total"]) +
  coord_flip() +
  scale_y_continuous(labels = comma) +
  labs(title = "English Learners Concentrated in Metro",
       subtitle = "Top 10 districts by number of EL students",
       x = "", y = "English Learner Students") +
  theme_readme()
```

## 10. Free/Reduced lunch shows economic divide

Minnesota's economic inequality is stark: from under 5% free/reduced lunch in wealthy districts like Edina and Minnetonka to over 70% in urban and rural districts. This gap has widened over the past decade.

```{r economic-divide, eval = FALSE}
econ <- enr_current %>%
  filter(is_district, subgroup == "econ_disadv", grade_level == "TOTAL",
         n_students > 500) %>%
  arrange(desc(pct)) %>%
  head(10) %>%
  mutate(district_label = reorder(district_name, pct))

ggplot(econ, aes(x = district_label, y = pct * 100)) +
  geom_col(fill = colors["total"]) +
  coord_flip() +
  labs(title = "Free/Reduced Lunch Shows Economic Divide",
       subtitle = "Top 10 districts by percent economically disadvantaged",
       x = "", y = "Percent Economically Disadvantaged") +
  theme_readme()
```

## 11. Duluth: Slow decline in the Northland

Minnesota's fourth-largest city has seen steady enrollment decline as the regional economy has struggled. The Duluth school district has closed several schools and faces ongoing budget pressures.

```{r duluth-decline, eval = FALSE}
duluth <- enr %>%
  filter(is_district, grepl("Duluth", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(duluth, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Duluth: Slow Decline in the Northland",
       subtitle = "Minnesota's fourth-largest city faces ongoing enrollment pressure",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 12. Native American students: concentrated in specific regions

Minnesota has significant Native American student populations, concentrated in districts near reservations including Red Lake, Cass Lake-Bena, and Fond du Lac. These districts often face unique funding and resource challenges.

```{r native-american-concentration, eval = FALSE}
native <- enr_current %>%
  filter(is_district, subgroup == "native_american", grade_level == "TOTAL") %>%
  arrange(desc(pct)) %>%
  filter(n_students >= 50) %>%
  head(10) %>%
  mutate(district_label = reorder(district_name, pct))

ggplot(native, aes(x = district_label, y = pct * 100)) +
  geom_col(fill = colors["native"]) +
  coord_flip() +
  labs(title = "Native American Students by District",
       subtitle = "Top 10 districts by percent Native American (min 50 students)",
       x = "", y = "Percent Native American") +
  theme_readme()
```

## 13. Anoka-Hennepin: The state's largest district

Anoka-Hennepin serves over 37,000 students across 42 schools, making it by far Minnesota's largest district. It has remained relatively stable while urban districts have declined, absorbing families from Minneapolis.

```{r anoka-hennepin, eval = FALSE}
ah <- enr %>%
  filter(is_district, grepl("Anoka-Hennepin", district_name, ignore.case = TRUE),
         subgroup == "total_enrollment", grade_level == "TOTAL")

ggplot(ah, aes(x = end_year, y = n_students)) +
  geom_line(linewidth = 1.5, color = colors["total"]) +
  geom_point(size = 3, color = colors["total"]) +
  scale_y_continuous(labels = comma, limits = c(0, NA)) +
  labs(title = "Anoka-Hennepin: Minnesota's Largest District",
       subtitle = "Over 37,000 students across 42 schools",
       x = "School Year", y = "Students") +
  theme_readme()
```

## 14. Rural consolidation continues

Small rural districts across Minnesota continue to consolidate or share services as enrollment declines. Many districts now have fewer than 500 students, making it difficult to offer comprehensive programming.

```{r rural-small-districts, eval = FALSE}
small_districts <- enr_current %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(size_category = case_when(
    n_students < 250 ~ "Under 250",
    n_students < 500 ~ "250-500",
    n_students < 1000 ~ "500-1,000",
    n_students < 5000 ~ "1,000-5,000",
    TRUE ~ "5,000+"
  )) %>%
  group_by(size_category) %>%
  summarize(n_districts = n(), .groups = "drop") %>%
  mutate(size_category = factor(size_category,
                                 levels = c("Under 250", "250-500", "500-1,000",
                                           "1,000-5,000", "5,000+")))

ggplot(small_districts, aes(x = size_category, y = n_districts)) +
  geom_col(fill = colors["total"]) +
  labs(title = "Many Minnesota Districts Are Small",
       subtitle = "Distribution of districts by total enrollment",
       x = "District Size", y = "Number of Districts") +
  theme_readme()
```

## 15. Special education rates vary by district

Special education identification rates vary significantly across Minnesota districts, from under 10% to over 20%. Larger urban districts tend to have higher identification rates, reflecting both student need and assessment capacity.

```{r sped-variation, eval = FALSE}
sped <- enr_current %>%
  filter(is_district, subgroup == "special_ed", grade_level == "TOTAL",
         n_students > 100) %>%
  arrange(desc(pct)) %>%
  head(15) %>%
  mutate(district_label = reorder(district_name, pct))

ggplot(sped, aes(x = district_label, y = pct * 100)) +
  geom_col(fill = colors["total"]) +
  coord_flip() +
  labs(title = "Special Education Rates Vary by District",
       subtitle = "Top 15 districts by percent receiving special education services",
       x = "", y = "Percent Special Education") +
  theme_readme()
```
