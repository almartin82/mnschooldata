---
title: "Getting Started with mnschooldata"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Getting Started with mnschooldata}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  message = FALSE,
  warning = FALSE,
  fig.width = 7,
  fig.height = 4
)
```

## Installation

Install from GitHub:

```r
# install.packages("remotes")
remotes::install_github("almartin82/mnschooldata")
```

## Quick Example

Fetch the most recent year of Minnesota enrollment data:

```{r fetch-data, eval = FALSE}
library(mnschooldata)
library(dplyr)

# Fetch 2024 enrollment data
enr <- fetch_enr(2024)

head(enr)
```

```{r load-cached-data}
# For vignette building, use cached data to avoid network calls
data("enr_2024_example", package = "mnschooldata")
enr <- enr_2024_example
head(enr)
```

## Understanding the Data

The data is returned in **tidy (long) format** by default:

- Each row is one subgroup for one school/district/state
- `subgroup` identifies the demographic group (e.g., "total_enrollment", "white", "black", "hispanic", "econ_disadv")
- `grade_level` shows the grade ("TOTAL", "K", "01", "02", etc.)
- `n_students` is the enrollment count
- `pct` is the percentage of total enrollment

```{r data-structure}
enr %>%
  filter(is_state) %>%
  select(end_year, type, subgroup, grade_level, n_students) %>%
  head(10)
```

## Filtering by Level

Use the aggregation flags to filter data:

```{r filter-levels}
# State totals
state <- enr %>% filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL")
state %>% select(end_year, n_students)

# All districts
districts <- enr %>% filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL")
nrow(districts)

# All schools
schools <- enr %>% filter(is_school, subgroup == "total_enrollment", grade_level == "TOTAL")
nrow(schools)
```

## Simple Analysis: Top 10 Districts

```{r top-districts}
enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  arrange(desc(n_students)) %>%
  select(district_name, n_students) %>%
  head(10)
```

## Demographic Analysis

```{r demographics}
# State demographics
enr %>%
  filter(is_state, grade_level == "TOTAL",
         subgroup %in% c("white", "black", "hispanic", "asian")) %>%
  select(subgroup, n_students, pct) %>%
  mutate(pct = round(pct * 100, 1))
```

## Wide Format

If you prefer wide format (one column per demographic), set `tidy = FALSE`:

```{r wide-format}
enr_wide <- fetch_enr(2024, tidy = FALSE)

enr_wide %>%
  filter(type == "State") %>%
  select(end_year, row_total, white, black, hispanic, asian, econ_disadv)
```

## Historical Data

Fetch multiple years to analyze trends:

```{r multi-year}
# Fetch 5 years of data
enr_multi <- fetch_enr_multi(2020:2024)

# State enrollment trend
enr_multi %>%
  filter(is_state, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  select(end_year, n_students)
```

## Minnesota-Specific Features

Minnesota has several unique district types:

```{r district-types}
enr %>%
  filter(is_district, subgroup == "total_enrollment", grade_level == "TOTAL") %>%
  mutate(district_type = case_when(
    grepl("^01", district_id) ~ "Independent School District",
    grepl("^03", district_id) ~ "Special School District (e.g., Minneapolis, St. Paul)",
    grepl("^06", district_id) ~ "Intermediate School District",
    grepl("^07", district_id) ~ "Charter School",
    TRUE ~ "Other"
  )) %>%
  count(district_type) %>%
  arrange(desc(n))
```

## Next Steps

- See `vignette("enrollment-trends")` for 15 stories Minnesota enrollment data
- Use `?fetch_enr` for full function documentation
